name: Docker Build and Push

on:
  push:
    branches: [main]
    paths:
      - Dockerfile
      - start.sh
      - Caddyfile
      - config.yaml.template
      - .github/workflows/docker-build.yml
  workflow_dispatch:

env:
  IMAGE_NAME: mihomo
  REGISTRY: ghcr.io
  DOCKERHUB_IMAGE_NAME: daitcl/mihomo

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      actions: read
      
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šè°ƒè¯•æ„å»ºç¯å¢ƒ
      - name: Debug build environment
        run: |
          echo "=== Build Environment ==="
          echo "Working directory: $(pwd)"
          echo "Files in repo:"
          ls -la
          echo ""
          echo "=== Dockerfile exists? ==="
          [ -f Dockerfile ] && echo "âœ… Dockerfile found" || echo "âŒ Dockerfile missing"
          echo ""
          echo "=== Check Dockerfile content ==="
          head -20 Dockerfile || echo "Cannot read Dockerfile"

      # æ­¥éª¤3ï¼šåŠ è½½å’ŒéªŒè¯ç¯å¢ƒå˜é‡
      - name: Load and validate environment variables
        id: set-versions
        run: |
          set -e
          
          # ç¡®ä¿.envæ–‡ä»¶å­˜åœ¨
          if [ ! -f .env ]; then
            echo "::error::.env file not found! Creating from .env.example if exists"
            if [ -f .env.example ]; then
              cp .env.example .env
              echo "Created .env from .env.example"
            else
              # åˆ›å»ºé»˜è®¤çš„ .env æ–‡ä»¶
              echo "MI_VERSION=v1.19.1" > .env
              echo "MetaCubeX_VERSION=v1.17.7" >> .env
              echo "Created default .env file"
            fi
          fi
          
          # å¤„ç†Windowsæ¢è¡Œç¬¦
          sed -i 's/\r$//' .env
          
          # å®‰å…¨åŠ è½½å˜é‡å¹¶éªŒè¯å¿…éœ€å­—æ®µ
          required_vars=("MI_VERSION" "MetaCubeX_VERSION")
          for var in "${required_vars[@]}"; do
            value=$(grep -E "^${var}=" .env | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            if [ -z "$value" ]; then
              echo "::warning::Missing or empty required variable: $var in .env file, using default"
              case $var in
                "MI_VERSION")
                  value="v1.19.1"
                  ;;
                "MetaCubeX_VERSION")
                  value="v1.17.7"
                  ;;
              esac
            fi
            echo "${var}=${value}" >> $GITHUB_ENV
            echo "âœ“ Set ${var}=${value}"
          done
          
          # è®¾ç½®é•œåƒå®Œæ•´åç§°
          echo "IMAGE_FULL_NAME=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}" >> $GITHUB_ENV
          echo "âœ“ Set IMAGE_FULL_NAME=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"

      # æ­¥éª¤4ï¼šéªŒè¯ç‰ˆæœ¬å¯ç”¨æ€§ï¼ˆå¯é€‰ï¼‰
      - name: Verify versions
        run: |
          set -e
          echo "=== Version Verification ==="
          
          # éªŒè¯ MetaCubeX ç‰ˆæœ¬
          metacubexd_version="${{ env.MetaCubeX_VERSION }}"
          echo "Verifying MetaCubeX version: $metacubexd_version"
          metacubexd_url="https://api.github.com/repos/MetaCubeX/metacubexd/tags"
          if ! curl -s -H "Accept: application/vnd.github.v3+json" "$metacubexd_url" | jq -e --arg version "$metacubexd_version" 'any(.[]; .name == $version)' > /dev/null 2>&1; then
            echo "::warning::MetaCubeX version $metacubexd_version might not exist or API limit reached. Continuing anyway..."
          else
            echo "âœ“ MetaCubeX version $metacubexd_version is valid"
          fi
          
          # éªŒè¯ MI ç‰ˆæœ¬
          mi_version="${{ env.MI_VERSION }}"
          echo "Verifying MI version: $mi_version"
          mi_releases_url="https://api.github.com/repos/MetaCubeX/mihomo/releases"
          if ! curl -s -H "Accept: application/vnd.github.v3+json" "$mi_releases_url" | jq -e --arg version "$mi_version" 'any(.[]; .tag_name == $version)' > /dev/null 2>&1; then
            echo "::warning::MI version $mi_version might not exist or API limit reached. Continuing anyway..."
          else
            echo "âœ“ MI version $mi_version is valid"
          fi

      # æ­¥éª¤5ï¼šç”Ÿæˆå‘å¸ƒè¯´æ˜
      - name: Generate release notes
        run: |
          echo "Generating release notes..."
          if [ -f release_notes.md.template ]; then
            sed -e "s/{{MI_VERSION}}/${{ env.MI_VERSION }}/g" \
                -e "s/{{MetaCubeX_VERSION}}/${{ env.MetaCubeX_VERSION }}/g" \
                release_notes.md.template > release_notes.md
          else
            echo "# Release Notes" > release_notes.md
            echo "Automated build of Mihomo with Metacubexd dashboard" >> release_notes.md
            echo "" >> release_notes.md
            echo "## Version Information" >> release_notes.md
            echo "- **Mihomo:** ${{ env.MI_VERSION }}" >> release_notes.md
            echo "- **Metacubexd:** ${{ env.MetaCubeX_VERSION }}" >> release_notes.md
            echo "- **Build Date:** $(date '+%Y-%m-%d %H:%M:%S')" >> release_notes.md
          fi
          
          echo -e "\n### é•œåƒURL" >> release_notes.md
          echo "- **GitHub Container Registry:** \`${{ env.IMAGE_FULL_NAME }}:${{ env.MI_VERSION }}\`" >> release_notes.md
          echo "- **Docker Hub:** \`${{ env.DOCKERHUB_IMAGE_NAME }}:${{ env.MI_VERSION }}\`" >> release_notes.md
          
          echo "Release notes generated:"
          cat release_notes.md

      # æ­¥éª¤6ï¼šç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Login to Docker Hub
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤7ï¼šè®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          buildkitd-flags: --allow-insecure-entitlement network.host

      # æ­¥éª¤8ï¼šæ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_FULL_NAME }}:${{ env.MI_VERSION }}
            ${{ env.IMAGE_FULL_NAME }}:latest
            ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ env.MI_VERSION }}
            ${{ env.DOCKERHUB_IMAGE_NAME }}:latest
          build-args: |
            MI_VERSION=${{ env.MI_VERSION }}
            MetaCubeX_VERSION=${{ env.MetaCubeX_VERSION }}
          platforms: linux/amd64
          labels: |
            org.opencontainers.image.version=${{ env.MI_VERSION }}
            org.opencontainers.image.description=Mihomo proxy core with Metacubexd dashboard
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          # ç®€åŒ–ç¼“å­˜é…ç½®ï¼Œé¿å…æ„å»ºé”™è¯¯
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # ç¦ç”¨ provenance ä»¥é¿å…æ„å»ºé”™è¯¯
          provenance: false
          # ç¦ç”¨ç¼“å­˜ç”¨äºè°ƒè¯•
          # no-cache: true

      # æ­¥éª¤9ï¼šæ›´æ–° Docker Hub æè¿°
      - name: Update Docker Hub description
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKERHUB_IMAGE_NAME }}
          readme-filepath: ./release_notes.md

      # æ­¥éª¤10ï¼šæ˜¾ç¤ºæ„å»ºæ‘˜è¦
      - name: Show build summary
        run: |
          echo "=== ğŸ‰ Build Successful ==="
          echo ""
          echo "ğŸ“¦ Image Details:"
          echo "  - Version: ${{ env.MI_VERSION }}"
          echo "  - Metacubexd: ${{ env.MetaCubeX_VERSION }}"
          echo "  - Build Date: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ“ Registry URLs:"
          echo "  - GHCR: https://${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}/pkgs/container/${{ env.IMAGE_NAME }}"
          echo "  - Docker Hub: https://hub.docker.com/r/${{ env.DOCKERHUB_IMAGE_NAME }}"
          echo ""
          echo "ğŸš€ Quick Start:"
          echo "  docker run -d -p 8080:8080 -p 7890:7890 ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ env.MI_VERSION }}"