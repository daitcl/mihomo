name: Update Dependency Versions

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 时间 00:00 自动执行
  workflow_dispatch:     # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get valid Mihomo version
        id: mihomo
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.repos.listTags({
              owner: 'MetaCubeX',
              repo: 'mihomo',
              per_page: 50
            });
            
            // 筛选符合 vX.XX.XX 格式的 tags
            const validTags = response.data
              .map(tag => tag.name)
              .filter(tag => /^v\d+\.\d+\.\d+$/.test(tag));
            
            if (validTags.length === 0) {
              console.log('No valid tags found for mihomo');
              return '';
            }
            
            // 返回最新有效的 tag
            return validTags[0];

      - name: Get valid MetaCubeXD version
        id: metacubexd
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.repos.listTags({
              owner: 'MetaCubeX',
              repo: 'metacubexd',
              per_page: 50
            });
            
            // 筛选符合 vX.XX.XX 格式的 tags
            const validTags = response.data
              .map(tag => tag.name)
              .filter(tag => /^v\d+\.\d+\.\d+$/.test(tag));
            
            if (validTags.length === 0) {
              console.log('No valid tags found for metacubexd');
              return '';
            }
            
            // 返回最新有效的 tag
            return validTags[0];

      - name: Update .env file if valid versions exist
        if: ${{ steps.mihomo.outputs.result != '' && steps.metacubexd.outputs.result != '' }}
        run: |
          echo "Updating to valid versions:"
          echo "MI_VERSION=${{ steps.mihomo.outputs.result }}"
          echo "MetaCubeX_VERSION=${{ steps.metacubexd.outputs.result }}"
          
          # 更新 .env 文件
          echo "MI_VERSION=${{ steps.mihomo.outputs.result }}" > .env
          echo "MetaCubeX_VERSION=${{ steps.metacubexd.outputs.result }}" >> .env

      - name: Commit changes
        if: ${{ steps.mihomo.outputs.result != '' && steps.metacubexd.outputs.result != '' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .env
          git commit -m "chore: update versions to mihomo ${{ steps.mihomo.outputs.result }} and metacubexd ${{ steps.metacubexd.outputs.result }}"
          git push

      - name: Skip update if no valid versions
        if: ${{ steps.mihomo.outputs.result == '' || steps.metacubexd.outputs.result == '' }}
        run: |
          echo "Skipping update:"
          echo "Mihomo valid version: ${{ steps.mihomo.outputs.result || 'none' }}"
          echo "MetaCubeXD valid version: ${{ steps.metacubexd.outputs.result || 'none' }}"